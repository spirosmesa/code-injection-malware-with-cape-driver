using System.IO;
using Analyzer.ModelParser.Internal;
using Antlr4.Runtime;
using Antlr4.Runtime.Tree;
using Analyzer.Model;

namespace Analyzer.ModelParser;

/// <summary>
/// Provides a mechanism for compiling behavior nets using the behavior graph Domain Specific Language (DSL).
/// </summary>
public static class BehaviorNetFactory
{
    /// <summary>
    /// Loads a behavior graph from the provided file.
    /// </summary>
    /// <param name="path">The path to the file containing the behavior graph in the DSL format.</param>
    /// <returns>The behavior graph.</returns>
    public static BehaviorGraph FromFile(string path) => FromCharStream(new AntlrFileStream(path));

    /// <summary>
    /// Loads a behavior graph from the provided string.
    /// </summary>
    /// <param name="text">The string containing the behavior graph in the DSL format.</param>
    /// <returns>The behavior graph.</returns>
    public static BehaviorGraph FromText(string text) => FromText(new StringReader(text));

    /// <summary>
    /// Loads a behavior graph from the provided reader.
    /// </summary>
    /// <param name="reader">The input stream containing the behavior graph in the DSL format.</param>
    /// <returns>The behavior graph.</returns>
    public static BehaviorGraph FromText(TextReader reader) => FromCharStream(new AntlrInputStream(reader));

    private static BehaviorGraph FromCharStream(ICharStream inputStream)
    {
        var lexer = new BehaviorNetLexer(inputStream);
        var parser = new BehaviorNetParser(new BufferedTokenStream(lexer));
        var tree = parser.behavior();

        var walker = new ParseTreeWalker();
        var builder = new BehaviorNetBuilder();
        walker.Walk(builder, tree);

        return builder.Result!;
    }
}